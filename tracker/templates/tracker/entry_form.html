<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Bank Tracker</title>
    <!-- Add Tailwind CSS via CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .editable-amount {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .editable-amount:hover {
            background-color: rgba(37, 99, 235, 0.1);
            border-radius: 0.25rem;
        }
        .amount-input {
            width: 8rem;
            text-align: right;
        }
    </style>
</head>
<body class="bg-gray-50">
    {% load account_filters %}
    <div class="container mx-auto px-4 py-6">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">Monthly Bank Account Tracker</h1>
        
        <!-- Add Account Form (Collapsed by default) -->
        <div class="bg-white rounded-lg shadow-md p-5 mb-8">
            <div class="flex justify-between items-center">
                <h2 class="text-lg font-semibold">Add New Account</h2>
                <button id="toggleAddForm" class="text-blue-600 hover:text-blue-800">
                    Show Form
                </button>
            </div>
            
            <div id="addAccountForm" class="hidden mt-4">
                <form method="POST" action="{% url 'add_account' %}" class="space-y-4">
                    {% csrf_token %}
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Bank Name</label>
                            <input type="text" name="bank_name" class="border p-2 rounded w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Name</label>
                            <input type="text" name="account_name" class="border p-2 rounded w-full" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Account Type</label>
                            <select name="account_type" class="border p-2 rounded w-full" required>
                                <option value="Current">Current</option>
                                <option value="Savings">Savings</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex justify-end">
                        <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                            Add Account
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Monthly Entries -->
        {% for month_name, month_data in entries_by_month %}
        <div class="bg-white rounded-lg shadow-md overflow-hidden mb-8 month-entry" data-month="{{ month_name }}">
            <h2 class="text-lg font-semibold p-4 bg-gray-50 border-b">{{ month_name }}</h2>
            
            <!-- Two Column Layout for Current and Savings -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-4">
                <!-- Current Accounts -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2 border-b pb-1">Current Accounts</h3>
                    <div class="space-y-2">
                        {% for entry in month_data.current %}
                        <div class="p-3 bg-gray-50 rounded flex justify-between items-center">
                            <div>
                                <p class="font-medium">{{ entry.bank_name }} - {{ entry.account_name }}</p>
                                {% if entry.notes %}
                                <p class="text-xs text-gray-500">{{ entry.notes }}</p>
                                {% endif %}
                            </div>
                            <span class="font-bold editable-amount {% if entry.amount < 0 %}text-red-600{% else %}text-green-600{% endif %}" 
                                  data-id="{{ entry.id }}" 
                                  data-amount="{{ entry.amount }}"
                                  data-type="current"
                                  data-month="{{ month_name }}">
                                £{{ entry.amount }}
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 italic">No current accounts</p>
                        {% endfor %}
                        
                        <!-- Current Total -->
                        {% if month_data.current %}
                        <div class="p-3 bg-blue-50 rounded mt-2 flex justify-between items-center">
                            <p class="font-medium">Current Total</p>
                            <span class="font-bold current-total" data-month="{{ month_name }}">
                                £{{ month_data.current|sum_amounts }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
                
                <!-- Savings Accounts -->
                <div>
                    <h3 class="font-medium text-gray-700 mb-2 border-b pb-1">Savings Accounts</h3>
                    <div class="space-y-2">
                        {% for entry in month_data.savings %}
                        <div class="p-3 bg-gray-50 rounded flex justify-between items-center">
                            <div>
                                <p class="font-medium">{{ entry.bank_name }} - {{ entry.account_name }}</p>
                                {% if entry.notes %}
                                <p class="text-xs text-gray-500">{{ entry.notes }}</p>
                                {% endif %}
                            </div>
                            <span class="font-bold editable-amount {% if entry.amount < 0 %}text-red-600{% else %}text-green-600{% endif %}" 
                                  data-id="{{ entry.id }}" 
                                  data-amount="{{ entry.amount }}"
                                  data-type="savings"
                                  data-month="{{ month_name }}">
                                £{{ entry.amount }}
                            </span>
                        </div>
                        {% empty %}
                        <p class="text-gray-500 italic">No savings accounts</p>
                        {% endfor %}
                        
                        <!-- Savings Total -->
                        {% if month_data.savings %}
                        <div class="p-3 bg-green-50 rounded mt-2 flex justify-between items-center">
                            <p class="font-medium">Savings Total</p>
                            <span class="font-bold savings-total" data-month="{{ month_name }}">
                                £{{ month_data.savings|sum_amounts }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
            
            <!-- Grand Total -->
            <div class="p-4 bg-gray-100 border-t">
                <div class="flex justify-between items-center font-semibold">
                    <p>Total Assets</p>
                    {% with current_total=month_data.current|sum_amounts savings_total=month_data.savings|sum_amounts %}
                    <span class="grand-total" data-month="{{ month_name }}">£{{ current_total|add:savings_total }}</span>
                    {% endwith %}
                </div>
            </div>
        </div>
        {% empty %}
        <div class="text-center p-6 bg-white rounded-lg shadow-md">
            <p class="text-gray-500">No entries yet. Add your first account to get started!</p>
        </div>
        {% endfor %}
    </div>

    <!-- JavaScript for inline editing -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Toggle Add Account form
            document.getElementById('toggleAddForm').addEventListener('click', function() {
                const form = document.getElementById('addAccountForm');
                const isHidden = form.classList.contains('hidden');
                form.classList.toggle('hidden');
                this.textContent = isHidden ? 'Hide Form' : 'Show Form';
            });
            
            // Handle editable amounts
            document.querySelectorAll('.editable-amount').forEach(function(element) {
                element.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const currentAmount = this.getAttribute('data-amount');
                    const accountType = this.getAttribute('data-type');
                    const monthName = this.getAttribute('data-month');
                    
                    // Create input field
                    const input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.value = currentAmount;
                    input.classList.add('border', 'p-1', 'rounded', 'amount-input');
                    
                    // Replace the span with input
                    const originalContent = this.innerHTML;
                    this.innerHTML = '';
                    this.appendChild(input);
                    input.focus();
                    
                    // Handle input blur (save)
                    input.addEventListener('blur', function() {
                        saveAmount(id, this.value, originalContent, element, accountType, monthName);
                    });
                    
                    // Handle Enter key
                    input.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            this.blur();
                        }
                    });
                });
            });
            
            function saveAmount(id, newAmount, originalContent, element, accountType, monthName) {
                // Make AJAX request to update amount
                fetch(`/update-amount/${id}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: newAmount
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update the element with new amount
                        const amount = parseFloat(data.amount);
                        element.innerHTML = '£' + amount.toFixed(2);
                        element.setAttribute('data-amount', amount);
                        
                        // Set color based on amount
                        if (amount < 0) {
                            element.classList.remove('text-green-600');
                            element.classList.add('text-red-600');
                        } else {
                            element.classList.remove('text-red-600');
                            element.classList.add('text-green-600');
                        }
                        
                        // Update totals
                        updateTotals(monthName, data.current_total, data.savings_total, data.grand_total);
                    } else {
                        // Revert to original content on error
                        element.innerHTML = originalContent;
                        console.error('Error updating amount:', data.error);
                    }
                })
                .catch(error => {
                    element.innerHTML = originalContent;
                    console.error('Error:', error);
                });
            }
            
            function updateTotals(monthName, currentTotal, savingsTotal, grandTotal) {
                // Update the current total
                const currentTotalElement = document.querySelector(`.current-total[data-month="${monthName}"]`);
                if (currentTotalElement) {
                    currentTotalElement.textContent = '£' + currentTotal.toFixed(2);
                }
                
                // Update the savings total
                const savingsTotalElement = document.querySelector(`.savings-total[data-month="${monthName}"]`);
                if (savingsTotalElement) {
                    savingsTotalElement.textContent = '£' + savingsTotal.toFixed(2);
                }
                
                // Update the grand total
                const grandTotalElement = document.querySelector(`.grand-total[data-month="${monthName}"]`);
                if (grandTotalElement) {
                    grandTotalElement.textContent = '£' + grandTotal.toFixed(2);
                }
            }
        });
    </script>
</body>
</html>